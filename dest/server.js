require("source-map-support").install(),function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=10)}([function(e,t){e.exports=require("path")},function(e,t,n){const r=n(5),o={headers:{"Accept-Encoding":""},timeout:1e4,decompress:!1,validateStatus:()=>!0},s=r.create({...o});e.exports={axios:r,axiosFetch:s}},function(e,t){e.exports=require("worker_threads")},function(e,t,n){const r=n(0),o=n(4),{axiosFetch:s}=n(1),a=r.resolve(__dirname),i=async()=>{try{const e=o.readFileSync(r.resolve(a,"package.json"),"utf8"),t=JSON.parse(e),{version:n}=t;return n}catch(e){return console.error(e),"0.0.0"}},c=async e=>{const{data:t}=await s({url:"https://raw.githubusercontent.com/daoquangphuong/free4talk-streaming/master/dest/"+e,method:"GET",responseType:"text",transformResponse:[e=>e]});return t},u=async()=>{try{const e=await c("package.json"),t=JSON.parse(e),{version:n}=t;return n}catch(e){return console.error(e),"0.0.0"}};e.exports={getCurrentVersion:i,getNextVersion:u,check:async()=>{const e=(await i()).split("."),t=(await u()).split(".");for(;e.length<t.length;)e.push("0");for(;t.length<e.length;)t.push("0");if(!t.some((t,n)=>t>e[n]))return;console.info("Has New Version "+t.join(".")),console.info("Updating..."),console.info("Please wait...");const n=await(async()=>{const{data:e}=await s({url:"https://github.com/daoquangphuong/free4talk-streaming/tree/master/dest",method:"GET",responseType:"text",transformResponse:[e=>e]});return e.match(/"\/daoquangphuong\/free4talk-streaming\/blob\/master\/dest\/(.+?)"/g).map(e=>e.match(/"\/daoquangphuong\/free4talk-streaming\/blob\/master\/dest\/(.+?)"/)[1])})();let p=Promise.resolve();n.forEach((e,t)=>{p=p.then(async()=>{console.info(`${t+1}/${n.length} Updating ${e}`),await(async e=>{const t=await c(e);o.writeFileSync(r.resolve(a,e),t,"utf8")})(e)})}),await p}}},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("express")},function(e,t,n){const r=n(21),o=n(22),s=n(8),a={},i=async(e,t=!0)=>{const n=await o.getTrackers(),a={...s.torrent,trackers:n},i=r(e,a);return new Promise((e,n)=>{const r=setTimeout(()=>{i.destroy(),n(new Error("Get Magnet Info Timeout"))},3e4);i.on("ready",()=>{clearTimeout(r);const n=i.files.filter(e=>(e.deselect(),e.engine=i,e.name.endsWith(".mp4")));t&&i.destroy(),e(n)})})};e.exports={getMp4Files:i,getFile:async(e,t)=>{if(a.file){if(a.magnetUrl===e&&a.path===t)return a.file;a.file.engine.destroy()}const n=(await i(e,!1)).find(e=>e.path===t);if(!n)throw new Error("File is not found");return a.magnetUrl=e,a.path=t,a.file=n,n}}},function(e,t,n){const r=n(0);e.exports={port:8888,torrent:{connections:100,uploads:0,tmp:r.resolve(__dirname,"../tmp"),path:r.resolve(__dirname,"../tmp/my-files"),verify:!0,dht:!0,tracker:!0,trackers:[]}}},,function(e,t,n){const r=n(6),o=n(11),s=n(12),a=n(8),i=r();i.use("/streaming",o(),s),i.listen(a.port,()=>{console.info("\nFree4Talk-Streaming-Server is started.\nYou can comeback Free4Talk and start to use Streaming.\n  ".trim())})},function(e,t){e.exports=require("cors")},function(e,t,n){const r=n(6),o=n(13),s=(n(14),n(15)),a=n(16),i=n(17),c=n(18),u=n(19),p=n(20),l=n(24),f=r.Router();f.use("/ping",s),f.use(i("before")),f.use(o.urlencoded({extended:!0})),f.use(o.json()),f.use(i("after")),f.post("/post/update",c),f.post("/get/version",u),f.post("/get/files",p),f.get("/get/video",l),f.use(a),e.exports=f},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=(e=1e3)=>async function(t,n,r){await new Promise(t=>setTimeout(t,e)),r()}},function(e,t){e.exports=function(e,t){return t.send("pong")}},function(e,t){e.exports=function(e,t,n,r){e instanceof Error?(console.error(e.stack),n.set({Connection:"close"}),n.status(500).json({success:!1,type:e.type,title:e.title,error:e.message,data:null})):e instanceof Buffer?(n.set({"Content-Type":"application/json","Content-Length":e.length}),n.write(e),n.end()):n.json({success:!0,error:null,data:e})}},function(e,t){function n(e,t,n){"POST"===e.method?(e.query.a&&(e.headers["content-type"]="application/json",delete e.query.a),n()):n()}function r(e,t,n){"POST"===e.method?(e.body&&e.body.body&&(e.body=e.body.body),n()):n()}e.exports=function(e){return"before"===e?n:r}},function(e,t,n){const{parentPort:r}=n(2);e.exports=async function(e,t,n){try{n(!0),t.on("close",()=>{r.postMessage({event:"update"})})}catch(e){n(e)}}},function(e,t,n){const{getCurrentVersion:r}=n(3);e.exports=async function(e,t,n){try{n({ver:await r()})}catch(e){n(e)}}},function(e,t,n){const r=n(7);e.exports=async function(e,t,n){try{const{url:t}=e.body;n({files:(await r.getMp4Files(t)).map(e=>({name:e.name,path:e.path,length:e.length}))})}catch(e){n(e)}}},function(e,t){e.exports=require("torrent-stream")},function(e,t,n){const r=n(23),{axiosFetch:o}=n(1),s={};e.exports={getTrackers:async()=>{if(s.trackers&&Date.now()-s.at<r("1h"))return s.trackers;const{data:e}=await o({url:"https://newtrackon.com/api/stable",method:"GET"}),t=(e||"").split("\n").filter(Boolean).map(e=>e.replace("/announce",""));return t.length&&(s.trackers=t,s.at=Date.now()),t}}},function(e,t){e.exports=require("ms")},function(e,t,n){const r=n(7);e.exports=async function(e,t,n){try{const{url:n,path:o}=e.query,s=await r.getFile(n,o),a=s.length,{range:i}=e.headers;let c;if(i){const{start:e,end:n}=((e,t)=>{let[n,r]=e.replace(/bytes=/,"").split("-");return n=parseInt(n,10),r=r?parseInt(r,10):t-1,!Number.isNaN(n)&&Number.isNaN(r)&&(r=t-1),Number.isNaN(n)&&!Number.isNaN(r)&&(n=t-r,r=t-1),{start:n,end:r}})(i,a);if(e>=a||n>=a)return t.writeHead(416,{"Content-Range":"bytes */"+a}),void t.end();t.writeHead(206,{"Content-Range":`bytes ${e}-${n}/${a}`,"Accept-Ranges":"bytes","Content-Length":n-e+1,"Content-Type":"video/mp4"}),c=s.createReadStream({start:e,end:n})}else t.writeHead(200,{"Content-Length":a,"Content-Type":"video/mp4"}),c=s.createReadStream();c.pipe(t),t.on("close",()=>{c.destroy()})}catch(e){n(e)}}}]);
//# sourceMappingURL=server.js.map